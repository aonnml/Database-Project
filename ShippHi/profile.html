<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
  <link rel="stylesheet" href="css/profile.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header จะถูกโหลดใส่ตรงนี้ -->
  <div id="header-container"></div>
  <script src="js/header-loader.js" defer></script>

  <button onclick="window.location.href='product.html'" class="back-btn">←</button>

  <div class="profile-container">
    <h2>Profile</h2>
    <div class="profile-avatar">
      <img id="profileImage" src="image/user.jpg" alt="Profile picture">
    </div>
    <div class="profile-info" id="profileInfo">
      <p><span>Name:</span> <span id="name"></span></p>
      <p><span>Last Name:</span> <span id="lastName"></span></p>
      <p><span>Address:</span> <span id="address"></span></p>
      <p><span>Phone:</span> <span id="phone"></span></p>
      <p><span>Email:</span> <span id="email"></span></p>
    </div>
    <form id="profileForm" class="profile-form" hidden enctype="multipart/form-data">
      <div class="form-field">
        <label for="inputName">Name</label>
        <input type="text" id="inputName" name="name" required>
      </div>
      <div class="form-field">
        <label for="inputLastName">Last Name</label>
        <input type="text" id="inputLastName" name="lastname" required>
      </div>
      <div class="form-field">
        <label for="inputAddress">Address</label>
        <textarea id="inputAddress" name="address" rows="3"></textarea>
      </div>
      <div class="form-field">
        <label for="inputPhone">Phone</label>
        <input type="tel" id="inputPhone" name="phone">
      </div>
      <div class="form-field">
        <label for="inputEmail">Email</label>
        <input type="email" id="inputEmail" name="email" required>
      </div>
      <div class="form-field">
        <label for="inputProfileImage">Profile Image</label>
        <input type="file" id="inputProfileImage" name="profileImage" accept="image/*">
        <small class="field-hint">Leave blank to keep your current photo.</small>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
    <button class="edit-btn" id="editProfileBtn">Edit</button>
  </div>

  <div class="menu">
    <div data-link="basket.html"><div class="icon">🛒</div><div>basket</div></div>
    <div data-link="payment.html"><div class="icon">💵</div><div>payment</div></div>
    <div data-link="review.html"><div class="icon">⭐</div><div>review</div></div>
  </div>

  <script>
    const profileInfo = document.getElementById('profileInfo');
    const profileForm = document.getElementById('profileForm');
    const editBtn = document.getElementById('editProfileBtn');
    const cancelBtn = document.getElementById('cancelEdit');
    const profileImageEl = document.getElementById('profileImage');
    const profileImageInput = document.getElementById('inputProfileImage');

  let profileData = null;
  let activePreviewUrl = null;

    fetch("backend/profile.php", { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
        profileData = data;
        renderProfile(data);
        fillForm(data);
      })
      .catch(err => console.error("Fetch error:", err));

    function getProfileImageSrc(path) {
      const fallback = 'image/user.jpg';
      if (!path || !path.trim()) {
        return fallback;
      }
      return path;
    }

    function renderProfile(data) {
      document.getElementById("name").textContent = data.name || '';
      document.getElementById("lastName").textContent = data.lastname || '';
      document.getElementById("address").textContent = data.address || '';
      document.getElementById("phone").textContent = data.phone || '';
      document.getElementById("email").textContent = data.email || '';
      profileImageEl.src = getProfileImageSrc(data.profile_image || '');
    }

    function fillForm(data) {
      document.getElementById("inputName").value = data.name || '';
      document.getElementById("inputLastName").value = data.lastname || '';
      document.getElementById("inputAddress").value = data.address || '';
      document.getElementById("inputPhone").value = data.phone || '';
      document.getElementById("inputEmail").value = data.email || '';
      profileImageInput.value = '';
    }

    function toggleEditMode(showForm) {
      if (showForm) {
        profileInfo.setAttribute('hidden', '');
        profileForm.removeAttribute('hidden');
        editBtn.setAttribute('hidden', '');
      } else {
        profileForm.setAttribute('hidden', '');
        profileInfo.removeAttribute('hidden');
        editBtn.removeAttribute('hidden');
        if (profileData) {
          renderProfile(profileData);
          fillForm(profileData);
        }
        profileImageInput.value = '';
        if (activePreviewUrl) {
          URL.revokeObjectURL(activePreviewUrl);
          activePreviewUrl = null;
        }
      }
    }

    editBtn.addEventListener('click', () => toggleEditMode(true));
    cancelBtn.addEventListener('click', () => toggleEditMode(false));

    profileImageInput.addEventListener('change', () => {
      if (activePreviewUrl) {
        URL.revokeObjectURL(activePreviewUrl);
        activePreviewUrl = null;
      }

      const [file] = profileImageInput.files;
      if (file) {
        activePreviewUrl = URL.createObjectURL(file);
        profileImageEl.src = activePreviewUrl;
      } else if (profileData) {
        profileImageEl.src = getProfileImageSrc(profileData.profile_image || '');
      }
    });

    profileForm.addEventListener('submit', (event) => {
      event.preventDefault();

      const formData = new FormData();
      formData.append('name', document.getElementById('inputName').value.trim());
      formData.append('lastname', document.getElementById('inputLastName').value.trim());
      formData.append('address', document.getElementById('inputAddress').value.trim());
      formData.append('phone', document.getElementById('inputPhone').value.trim());
      formData.append('email', document.getElementById('inputEmail').value.trim());

      const imageFile = profileImageInput.files[0];
      if (imageFile) {
        formData.append('profileImage', imageFile);
      }

      fetch('backend/update_profile.php', {
        method: 'POST',
        credentials: 'include',
        body: formData
      })
        .then(res => res.json())
        .then(result => {
          if (result.status !== 'success') {
            alert(result.message || 'Unable to update profile.');
            return;
          }

          profileData = {
            ...profileData,
            name: formData.get('name'),
            lastname: formData.get('lastname'),
            address: formData.get('address'),
            phone: formData.get('phone'),
            email: formData.get('email'),
            profile_image: result.profile_image || profileData?.profile_image || ''
          };

          profileImageInput.value = '';
          if (activePreviewUrl) {
            URL.revokeObjectURL(activePreviewUrl);
            activePreviewUrl = null;
          }
          renderProfile(profileData);
          toggleEditMode(false);
          alert('Profile updated successfully.');
        })
        .catch(() => {
          alert('Something went wrong. Please try again.');
        });
    });

    document.querySelectorAll('.menu div').forEach(item => {
      item.addEventListener('click', () => {
        const link = item.getAttribute('data-link');
        window.location.href = link;
      });
    });
  </script>
</body>
</html>
