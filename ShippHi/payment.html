<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Payment | SHIPP HI</title>
  <link rel="stylesheet" href="css/payment.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header จะถูกโหลดใส่ตรงนี้ -->
  <div id="header-container"></div>
  <script src="js/header-loader.js" defer></script>

  <button class="back-btn" onclick="window.location.href='profile.html'">&larr; Back</button>
  <h2>Payment</h2>

  <table id="cart-table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="3" style="text-align:right;">Total:</td>
        <td id="total-price"><strong>0 ฿</strong></td>
      </tr>
    </tfoot>
  </table>

  <div style="text-align:center;">
    <button id="confirm-payment">Confirm Payment</button>
  </div>

  <div id="checkout">
    <div class="amount"></div>
    <img id="qrcode" src="" alt="QR Code">
    <div style="margin-top:20px;">
      <button id="done-payment">Done</button>
    </div>
  </div>

  <script>
    let totalAmount = 0;
    let cartItems = [];

    const tbody = document.querySelector('#cart-table tbody');
    const selectedIds = JSON.parse(localStorage.getItem('selectedCartItems') || '[]');

    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">ไม่มีสินค้าที่เลือกไว้ กรุณากลับไปหน้าตะกร้า</td></tr>';
      document.getElementById('confirm-payment').disabled = true;
    } else {
      fetch('backend/payment.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ cartIds: selectedIds })
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#d00;">ไม่สามารถโหลดข้อมูลได้</td></tr>';
            document.getElementById('confirm-payment').disabled = true;
            return;
          }

          cartItems = data.cartItems || [];

          if (!cartItems.length) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">ไม่มีสินค้าที่เลือกไว้ กรุณากลับไปหน้าตะกร้า</td></tr>';
            document.getElementById('confirm-payment').disabled = true;
            return;
          }

          tbody.innerHTML = '';

          cartItems.forEach(item => {
            const price = Number(item.price) || 0;
            const quantity = Number(item.quantity) || 0;
            const subtotal = Number(item.subtotal) || price * quantity;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${item.name}</td>
              <td>${price.toLocaleString()} ฿</td>
              <td>${quantity}</td>
              <td>${subtotal.toLocaleString()} ฿</td>
            `;
            tbody.appendChild(tr);
          });

          totalAmount = Number(data.totalPrice) || 0;
          document.getElementById('total-price').innerHTML = `<strong>${totalAmount.toLocaleString()} ฿</strong>`;
        })
        .catch(err => {
          console.error('Fetch error:', err);
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#d00;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
          document.getElementById('confirm-payment').disabled = true;
        });
    }

    document.getElementById('confirm-payment').addEventListener('click', () => {
        if (!cartItems || cartItems.length === 0) {
            alert('ตะกร้าว่าง ไม่มีสินค้าให้ชำระเงิน');
            return;
        }

        document.getElementById('confirm-payment').style.display = 'none';

        const checkoutDiv = document.getElementById('checkout');
        checkoutDiv.style.display = 'block';
        checkoutDiv.querySelector('.amount').textContent = `ยอดชำระทั้งหมด: ${totalAmount.toLocaleString()} ฿`;
        document.getElementById('qrcode').src = 'image/qr-payment.jpg';
    });


    document.getElementById('done-payment').addEventListener('click', () => {
      if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
        alert('ไม่พบสินค้าที่เลือก กรุณากลับไปหน้าตะกร้า');
        return;
      }

      fetch('backend/checkout.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ cartIds: selectedIds })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          localStorage.setItem('cartItems', JSON.stringify(cartItems));
          localStorage.setItem('totalAmount', totalAmount);
          localStorage.removeItem('selectedCartItems');
          window.location.href = 'review.html';
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => console.error(err));
    });
  </script>
</body>
</html>
